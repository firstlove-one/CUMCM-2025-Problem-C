# CUMCM-2025-Problem-C

**NIPT 检测策略优化与女胎异常识别模型研究**  
——湖北省赛区一等奖（WHUT）

本仓库包含论文 **《基于动态规划算法的 NIPT 检测策略与女胎异常识别方法研究》** 的全部源代码与 LaTeX 模板，系统解决无创产前检测（Non-Invasive Prenatal Testing，NIPT）在检测时点规划、风险最优化、女胎异常识别中的关键建模问题。

---

## 📂 仓库结构

```text
.
├── code/
│   ├── t1.py       # 问题 1 完整算法（GBDT）
│   ├── t2.py       # 问题 2 完整算法（DP）
│   ├── t3.py       # 问题 3 完整算法（前缀和 + DP）
│   ├── t1main.py   # 问题 1 主程序
│   ├── t2main.py   # 问题 2 主程序
│   ├── t3main.py   # 问题 3 主程序
│   ├── t4main.py   # 问题 4 主程序
│
├── [template.tex]    # LaTeX 论文源码
├── [论文.pdf]        # 最终论文
└── [README.md]


## 🧩 问题一：男胎 Y 染色体浓度关系模型（`code/t1.py`）

### 算法思想

- 首先对附件数据进行预处理：多次尝试编码读取 CSV，统一列名，选取年龄、检测孕周、孕妇 BMI、13/18/21 号染色体 Z 值等候选变量，并与胎儿 Y 染色体浓度一起转为数值类型，删除缺失行。
- 用 **Spearman 秩相关** 分析 Y 浓度与各变量的相关性，输出 `Q1_Spearman_vs_Y.csv`，并选出绝对相关性最高的前三个指标，用于后续更深入的分析与绘图。
- 目标变量 Y 在 (0,1) 之间，先进行轻微裁剪后使用 **logit 变换**，通过 `TransformedTargetRegressor` 在回归时对目标做 logit/反 logit 映射，保证数值稳定且预测值保持在合理区间内。
- 特征侧使用 `QuantileTransformer + StandardScaler + PolynomialFeatures` 构建预处理流水线：
  - 分位数变换把偏态/长尾特征映射到近似正态分布；
  - 标准化消除量纲；
  - 二次多项式扩展显式引入非线性与交互项。
- 主模型采用 **梯度提升回归树**（`GradientBoostingRegressor`, GBDT），并嵌入到整体 `Pipeline` 中，再经 `TransformedTargetRegressor` 封装。
- 使用 **5 折交叉验证**（`KFold`, `shuffle=True`）做 out-of-fold 评估：在每折上单独拟合一个 GBDT 模型，记录 Spearman 相关、MAE、RMSE、R² 等指标，并输出 `Q1_CV_metrics.csv`。
- 最终在全数据上拟合一个 GBDT 模型，用来绘制：
  - 真实值 vs 预测值散点及“y=x”对角线（`Q1_model_fit.png`）；
  - 按真实值排序的时间序列曲线（`Q1_true_pred_series.png`）。
- 进一步通过 **整体置换检验 + 特征置换重要性** 评价模型显著性和变量贡献：
  - 固定特征矩阵，随机打乱标签多次，重复交叉验证，构造 R² 的置换分布，输出 `Q1_permtest_overall.csv` 和直方图；
  - 对每个特征进行多次置换，计算 R² 降幅的均值和标准差，通过 `statsmodels.multipletests` 做 FDR-BH 校正，输出 `Q1_permutation_importance_R2.csv` 与条形图。
- 对最重要的几个特征（例如 BMI、孕周等）构造 **部分依赖曲线（PDP）**，利用自助法重复采样重训模型，给出 95% 置信带，输出 `Q1_PDP_*.png`。

### 为什么使用 GBDT + 这些统计方法？

- Y 浓度与 BMI、孕周、Z 值之间呈 **明显非线性 / 非单调关系**，线性回归或简单多项式回归难以刻画；GBDT 天然擅长拟合非线性和高阶交互。
- 样本规模中等，特征维度不算太高，GBDT 在小中型 tabular 数据上表现稳定，兼具精度与可解释性，比深度神经网络更稳健、训练更方便。
- `QuantileTransformer + StandardScaler + PolynomialFeatures` 可以在保持模型灵活性的前提下，减轻异常值和尺度不一致带来的问题，并让部分关系在变换空间接近线性，便于树模型学习。
- 通过 **交叉验证 + 置换检验 + 特征重要性**，不仅给出“拟合得好不好”，还从统计意义上验证“模型整体是否显著”“哪些变量真正重要”，使结果更有说服力。

---

## 🧮 问题二：基于 BMI 的最优检测时点动态规划（`code/t2.py`）

### 算法思想

- 从 Excel 中读取男胎数据，根据身高体重计算 BMI，并解析“检测孕周”字符串为数值孕周（周）。
- 将每个孕妇在多次检测中的 Y 浓度记录，构造 **“就绪时间区间”**：在某个孕周之前尚未达到阈值，之后达到阈值，以区间形式编码为 `SubjectInterval`，形成时间到达标的生存型数据。
- 用一个参数化模型（`TimeToReadyModel`）对“首次达标孕周 $T^*$ 的分布 $F(t\mid b)$”进行拟合，其中 $b$ 为 BMI。模型通过最大似然（负对数似然最小化）拟合，并加入 L2 正则平衡拟合与稳定性。
- 构建 **孕周风险权重函数 $w(t)$**：孕周越晚，潜在临床治疗风险越大；通过分段函数和参数 $(\alpha,\beta)$ 控制风险随孕周推进的增长速度。
- 在给定 BMI 组、检测时点 $t$ 下，综合考虑：
  - 检测时已经“就绪”（Y 浓度达阈值）的概率 $F(t\mid b)$；
  - 未就绪情况下，需要重检 + 未来更晚孕周带来的额外风险。
- 定义每个 BMI 值 $b$ 在检测时点 $t$ 下的期望风险 $R(t\mid b)$，并在孕周网格上预先计算风险矩阵。
- 将人群按 BMI 排序，在候选的 BMI 划分点和候选孕周时点组成离散网格，使用 **动态规划（DP）**：
  - 状态为“前 $i$ 个人分成 $k$ 组的最小总风险”；
  - 转移枚举上一个分组的结束位置 $j$ 和该组的首检孕周 $t$，利用前缀和预计算好的组内平均风险；
  - 叠加 **组内首检达标率约束**（如 ≥0.95），过滤不安全的方案。
- 最终得到每个 BMI 分组的区间和对应的最优首检孕周，使 **全体平均风险最小**，同时满足临床安全约束；并配套收敛性与敏感性分析，验证结果稳健。

### 为什么使用动态规划来解决问题二？

- 问题本质是：在一维 BMI 空间上做分段分组，每组选择一个检测孕周，使加权平均风险最小，同时带有约束（首检达标率下界）。这是一个典型的“分段优化 + 全局最优”问题。
- 贪心策略（例如按局部最小风险分组）容易陷入局部最优，无法保证整体最优；穷举所有分组与检测时点组合则计算量爆炸。
- 动态规划能够：
  - 在可接受的时间复杂度内，枚举所有合理的分组方式与检测时点；
  - 借助前缀和等技巧把组内风险计算从 $O(n)$ 降到 $O(1)$，整体复杂度从指数级降至多项式；
  - 自然加入“组内达标率 ≥ 某阈值”等约束，通过不可行转移设为无穷大即可。
- 因此，DP 是在全局最优性、约束处理能力与计算复杂度之间比较平衡的选择，尤其适合这类“连续量（BMI）上分段 + 每段选最优策略”的规划问题。

---

## 📊 问题三：多因素协变量 + 前缀和优化的动态规划（`code/t3.py`）

### 算法思想

- 相比问题二，问题三引入更多协变量：孕妇年龄、Z13/Z18/Z21 等，并允许多次检测记录，构建更一般的 **加速失效时间 / 生存模型**（`AFTLogLogistic`）。
- 从 Excel 自动/模糊识别“孕妇代码、孕周、Y 浓度、BMI、年龄、各染色体 Z 值”等列（见 `pick_columns` 和 `fuzzy_pick`），适应不同表头写法。
- 将原始检测记录转成 `SubjectInterval`，结合达标阈值和孕周上界 $H$，构造区间删失数据，用对数逻辑分布族拟合 $F(t\mid x)$，其中 $x$ 是多维协变量。
- 模型在拟合过程中额外加入多种正则项（对基线函数、位置/尺度参数、平滑性等的惩罚），并通过多轮连续拟合（`cont_rounds`）与目标正例比例控制参数，使得就绪时间分布既符合数据又不过拟合少数异常。
- 在风险函数构造上与问题二一致：依赖 $F(t\mid x)$ 和 $w(t)$，并引入“早检失败重检成本 + 晚检治疗风险”的统一度量。
- 针对 **给定分组方案**（如若干 BMI 区间），计算每个组在各候选检测孕周上的平均风险矩阵；利用 **前缀和与专门设计的 DP 函数**（如 `dp_segment_with_ready_size`、`enforce_monotone_with_gap`）在：
  - 约束最小样本量；
  - 保证检测时点整体单调性 / 分组有间隔；
  - 满足达标率约束  
  等前提下，搜索全局最优的分组及检测时点。
- 为衡量统计不确定性，提供 **自助法（bootstrap）** 重采样：多次重训 AFT 模型、重算各组达标曲线与关键孕周点，得到置信区间并作可视化（如 group curves、CI 带等）。

### 为什么在问题三中用“协变量生存模型 + 前缀和优化的 DP”？

- 与问题二相比，本问需要 **同时考虑多种协变量** 对“达标时间”的影响，这种“时间到事件 + 协变量”结构天然适合用生存模型（AFT / Cox 类）刻画。
- 使用对数逻辑 AFT 模型，可以：
  - 直接输出 $F(t\mid x)$，便于与风险函数 $R(t\mid x)$ 对接；
  - 通过线性预测子和尺度函数引入 BMI、年龄、Z 值等影响，结构清晰、可解释性强。
- 在优化层面，本质仍然是“在一维 BMI 或多维特征排序后做分段 + 每段选择最优检测孕周”的问题，依然适合 **动态规划**；但由于维度更高、约束更多，必须通过前缀和和专门的 DP 设计来降低复杂度。
- 前缀和 + 单调性修正（`enforce_monotone_with_gap`）可以：
  - 避免在 DP 转移时重复累加风险，提高效率；
  - 从算法层面保证分组的 BMI 区间与对应检测周数具有合理的单调性，更符合临床直觉（BMI 越高，一般建议检测略后移）。
- 因此，本问在“统计建模层面”采用 AFT 生存模型，在“策略搜索层面”继续使用经过优化的 DP，是对问题二方法的自然扩展与加强。

---

## 🧬 问题四：女胎异常评分与分层阈值判定（`code/t4main.py`）

### 算法思想

- 由于女胎没有 Y 染色体，无法像男胎一样通过 Y 浓度达标与否来直接评估检测是否可靠，需要构造一个 **综合异常评分系统**：
  - 以男胎阴性样本构建“正常参照分布”，包括测序质量相关指标（GC 含量、reads、比对率、重复率、过滤比例、唯一比对读段数等）以及各条染色体 Z 值；
  - 通过函数 `estimate_qc_thresholds` 和 `qc0_status` 对测序质量做初筛，剔除明显不合格样本。
- 对 X 染色体 Z 值进行 **协变量去趋势（detrend）** 和正规化，得到 `XGateParams`，用于判断 X 染色体信号是否在正常范围内（`x_gate_status`）。
- 利用男胎阴性样本估计多维 **Mahalanobis 距离**、单变量 tail probability 等，构造融合质量、GC、Z 值的“异常程度”度量（`mahalanobis_tail_prob`、`robust_feature_tail` 等）。
- 进一步训练一个 **弱判别模型（Logistic 回归）**，区分男胎阴性与明显异常/阳性样本，从而在多维特征空间学习一个概率刻度（`weak_discriminator_scores`），输出类似“异常概率”的评分。
- 在得到“异常评分”后，结合孕周分层 / BMI 分层，通过 `quantile_bins`、`apply_bins_with_edges` 将人群划分为多个风险层级，对每个层级分别估计在给定假阳性率目标下的阈值（`compute_thresholds_by_mode`）。
- 最终判定某个女胎样本时，按其所属孕周 / BMI 分组，选择对应的阈值（`select_threshold_for_row`），若异常评分超过阈值则判为“异常”或“需重点关注”。

### 为什么这样设计女胎异常判定算法？

- 女胎缺乏类似男胎 Y 浓度的“金标准”连续指标，只能从 **多维间接信号**（测序质量、GC、各染色体 Z 值等）中提取异常模式，问题本质更接近 **多变量异常检测 / 风险评分**。
- 仅靠单一 Z 值阈值极易产生大量假阳性或假阴性；通过：
  - 质量控制阈值；
  - 多变量概率尾部（Mahalanobis + 单变量 tail）；
  - Logistic 概率刻度；  
  可以把不同来源的信息统一到“异常概率”这个一维评分上，更便于解释和调参。
- 按孕周 / BMI 分层，分别设定阈值，可以：
  - 反映不同人群 **基础风险水平不同** 的事实；
  - 在总体假阳性率控制在目标范围（如 5% 左右）的前提下，使各层级内的判定更均衡、更公平。
- 因此，这套方法相当于是 **“男胎阴性 → 正常参照标尺 → 多源证据融合 → 概率校准 → 分层阈值控制假阳性率”** 的 pipeline，既符合临床上“宁可稍保守、也要稳健可解释”的需求，又保留了较好迁移性。